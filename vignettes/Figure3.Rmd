---
title: "Figure 3"
output: 
  html_document:
    dev: "svg"
---

```{r grandR, echo = FALSE}
library(devtools)
load_all()

suppressPackageStartupMessages({
  #library(grandR)
  library(dplyr)
  library(readr)
  library(gridExtra)
  })

```
Load default setting data (in that case: 3 replicates, 1,2,4,8 h, 20M reads) 
To see how this data was generated have a look into (#REVIEW filename) corresponding Rscript.
```{r load data,echo = FALSE}
data_default= readRDS('~/Dokumente/Mock.default.all.methods.rds')
```

```{r}
state = 'ss'
cols = 'Half-life'
tab = GetAnalysisTable(data_default,columns=cols)
tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars =c(paste0('ntr.',state,'.',cols),
                            paste0('entr.',state,'.',cols),
                            paste0('nlls.',state,'.',cols),
                            paste0('lm.',state,'.',cols),
            paste0('pulseR.',state,'.',cols))
            )
if (cols == 'Half-life')  tabm$Y = (log(2)/tabm$true_d)
if (cols == 'Synthesis')  tabm$Y = tabm$true_s
tabm$diff_relative = log2((tabm$Y/tabm$value))
names(tabm)[names(tabm) == 'variable'] <- 'method'
ggplot(tabm, aes(x=diff_relative, color=method, linetype = method)) + 
   stat_ecdf(geom = "line",size=0.8)+ coord_cartesian(xlim=c(-1.5,4)) + xlab('log2 fold change') + ylab('cumulative frequency') + geom_vline(xintercept = 0)+
   scale_color_brewer(name = "method",labels = c("ntr", "entr","nlls","lm",'pulseR'),palette = 'Paired')+
   scale_linetype_discrete(name = "method", labels = c("ntr", "entr","nlls","lm",'pulseR'))
  
```
```{r}
state = 'noss'
cols = 'Half-life'
tab = GetAnalysisTable(data_default,columns=cols)
tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars =c(paste0('ntr.',state,'.',cols),
                            paste0('entr.',state,'.',cols),
                            paste0('nlls.',state,'.',cols),
                            paste0('lm.',state,'.',cols),
            paste0('pulseR.',state,'.',cols))
            )
if (cols == 'Half-life')  tabm$Y = (log(2)/tabm$true_d)
if (cols == 'Synthesis')  tabm$Y = tabm$true_s
tabm$diff_relative = log2((tabm$Y/tabm$value))
names(tabm)[names(tabm) == 'variable'] <- 'method'
ggplot(tabm, aes(x=diff_relative, color=method, linetype = method)) + 
   stat_ecdf(geom = "line", size=0.8)+ coord_cartesian(xlim=c(-2,5)) + xlab('log2 fold change') + ylab('cumulative frequency') + geom_vline(xintercept = 0)+
   scale_color_brewer(name = "method",labels = c("ntr", "entr","nlls","lm",'pulseR'),palette = 'Paired')+
   scale_linetype_discrete(name = "method", labels = c("ntr", "entr","nlls","lm",'pulseR'))
```

Plots showing the relative deviation of inferred HLs from ground truth as cumulative distribution. (First Plot is steady state, Second Plot is non steady state)


```{r plot function CI, echo=FALSE,message=FALSE}
confidence_ok <- function(method,RDS,state = 'ss',cols='Half-life'){
  tab = GetAnalysisTable(RDS,columns=cols)
  if (cols == 'Half-life')  Y = (log(2)/tab$true_d)
  if (cols == 'Synthesis')  Y = tab$true_s
  x = ((Y >= tab[[paste0(method,'.',state,'.',cols,'.lower')]] ) & (Y <= tab[[paste0(method,'.',state,'.',cols,'.upper')]]))
  return(x)
}

plot_CI <- function(RDS,state = 'ss',cols = 'Half-life'){
  tab = GetAnalysisTable(RDS,columns=cols)
  tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars =c(paste0('ntr.',state,'.',cols),
                            paste0('entr.',state,'.',cols),
                            paste0('nlls.',state,'.',cols),
                            paste0('lm.',state,'.',cols)))
if (cols == 'Half-life')  tabm$Y = (log(2)/tabm$true_d)
if (cols == 'Synthesis')  tabm$Y = tabm$true_s
borders = c(quantile(tabm$Y,1/3),quantile(tabm$Y,2/3),quantile(tabm$Y,3/3))
tabm$HL <- sapply(tabm$Y, FUN = function(x) if(x<=borders[1]) 'short' else if ((x>=borders[1])&(x<=borders[2])) 'medium' else 'long')
tabm$ok = c('ntr'= confidence_ok(method='ntr',RDS=RDS,state = state,cols=cols),
           'entr'=confidence_ok(method='entr',RDS=RDS,state = state,cols=cols),
           'nlls'=confidence_ok(method='nlls',RDS=RDS,state = state,cols=cols),
           'lm'= confidence_ok(method='lm',RDS=RDS,state = state,cols=cols))
tabm$ok = as.numeric(tabm$ok)
names(tabm)[names(tabm) == 'variable'] <- 'method'
tab2 = tabm %>% 
      group_by(method, HL) %>%
      summarise(ok = sum(na.omit(ok))/length(na.omit(ok)))
tab2$method = sub('\\..*', '',tab2$method)
tab2$HL = factor(tab2$HL,levels=c('short','medium','long'))
ggplot(data=tab2,aes(x=method,y=ok,fill=HL))+geom_bar(aes(fill=HL),stat = 'identity',position='dodge2')+geom_text(aes(label=round(ok,digits=2)),hjust=0.5,vjust=-0.5,position = position_dodge(width = 1))+ geom_vline(xintercept = 0)+
  ylab('Proportion of values inside CI') + xlab ('method') +theme_cowplot(12)+scale_fill_brewer(palette = 'Reds')
}

```
Barplots displaying the amount of estimated HLs inside the confidence intervals.(First Plot is steady state, Second Plot is non steady state)
```{r plots CI, warning=FALSE,echo=FALSE, message=FALSE}
plot_CI(data_default,state = 'ss')
plot_CI(data_default,state = 'noss')
```

Plot which compares confidence interval sizes (Test Scatterplots, Boxplots etc.)

```{r}

confidence_size <- function(method,RDS,state = 'ss',cols='Half-life'){
  tab = GetAnalysisTable(RDS,columns=cols)
  if (cols == 'Half-life')  Y = (log(2)/tab$true_d)
  if (cols == 'Synthesis')  Y = tab$true_s
  x = (tab[[paste0(method,'.',state,'.',cols,'.upper')]] - tab[[paste0(method,'.',state,'.',cols,'.lower')]])
  return(x)
}

Plot_Box_CI_size <- function(RDS,state,cols) {
  tab = GetAnalysisTable(RDS,columns=cols)
  size = data.frame('gene' = rownames(tab),
                    'ntr'= confidence_size(method='ntr',RDS=RDS,state = state,cols=cols),
           'entr'=confidence_size(method='entr',RDS=RDS,state = state,cols=cols),
           'nlls'=confidence_size(method='nlls',RDS=RDS,state = state,cols=cols),
           'lm'= confidence_size(method='lm',RDS=RDS,state = state,cols=cols))
tabm = melt(size, id.vars = 'gene')
ggplot()+geom_boxplot(data=tabm, aes(x=variable,y=value,fill=variable))+xlab('method')+ylab('size of confidence intervals')+coord_cartesian(ylim=c(0,6))+
   scale_fill_brewer(palette = 'Paired')
}

```

```{r}
Plot_Box_CI_size(data_default,'ss','Half-life')
Plot_Box_CI_size(data_default,'noss','Half-life')
```
```{r compare tps and replicates, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20,fig.height=8}
data = readRDS('~/Dokumente/default.reads.replicates.timepoints.3.rds') 
tab = GetAnalysisTable(data,columns=c('Half-life'),analyses='nlls.ss')
tab = tab[,-grep('upper|lower',names(tab))]
tab$`nlls.ss.Half-life` = NULL
tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars = names(tab)[grep('Half-life',names(tab))])
  tabm$Y = (log(2)/tabm$true_d)
  tabm$diff_relative = log2(tabm$Y/tabm$value)
  names(tabm)[names(tabm) == 'variable'] <- 'method'
  tabm$reps = parse_number(sapply(c(1:length(tabm$method)), function(i)    strsplit(as.character(tabm$method[i]),'[.]')[[1]][1]))
  tabm$tps = sapply(c(1:length(tabm$method)), function(i) strsplit(as.character(tabm$method[i]),'[.]')[[1]][2])
  reps1=as.character(list(c(0,1,2,4,8),c(0,1,2,4),c(0,2,4,8),c(0,1,2,8),c(0,1,4,8)))
  reps2=as.character(list(c(0,1,2,4,8),c(0,1,2),c(0,2,4),c(0,2,8),c(0,4,8),c(0,1,4),c(0,1,8),c(0,1),c(0,2),c(0,4)))
  reps3=as.character(list(c(0,1,2,4),c(0,2,4,8),c(0,1,2,8),c(0,1,4,8)))
  reps4=as.character(list(c(0,1,2),c(0,2,4),c(0,2,8),c(0,4,8),c(0,1,4),c(0,1,8),c(0,1),c(0,2),c(0,4)))
  names(reps1) = paste0('tp',c(1:length(reps1)))
  names(reps2)=paste0('t',c(1:length(reps2)))
  names(reps3)=paste0('t',c(1:length(reps3)))
  names(reps4)=paste0('t',c(1:length(reps4)))
  for (i in c(1:length(reps2))) tabm$tps[(tabm$reps==2)&tabm$tps==paste0('t',i)] = reps2[i]
  for (i in c(1:length(reps1))) tabm$tps[(tabm$reps==1)&tabm$tps==paste0('t',i)] = reps1[i]
  for (i in c(1:length(reps3))) tabm$tps[(tabm$reps==3)&tabm$tps==paste0('t',i)] = reps3[i]
  for (i in c(1:length(reps4))) tabm$tps[(tabm$reps==4)&tabm$tps==paste0('t',i)] = reps4[i]
  tabm$ltp = sapply(c(1:length(tabm$tps)), function(i) length((strsplit(tabm$tps[[i]],'[,]')[[1]])))
tabm$HL <- sapply(tabm$Y, FUN = function(x) if(x<1) '0h-1h' else if ((x>=1)&(x<2)) '1h-2h'else if ((x>=2)&(x<4)) '2h-4h' else '4h and more')
tabm$tps = tabm$tps %>% stringr::str_match_all("[0-9]+") %>% sapply(function(i) paste0(i,'h')) %>% sapply(toString)
tabm$labels = paste(tabm$reps, 'x', tabm$tps)
ggplot(tabm, aes(x=reorder(labels,ltp),y=diff_relative,fill=HL)) + theme_minimal_hgrid()+
  geom_boxplot(notch=T)+
 coord_cartesian(ylim = c(-0.5,2.15))+scale_y_continuous(breaks = seq(from = -0.5, to =2.15, by = 0.3))+
  theme(axis.text.x = element_text(size=12, angle=90, hjust = 1, vjust = 0.4)) + ylab('log FC true HL/inferred HL') + xlab('') + scale_fill_brewer(palette='Reds')
```

```{r compare tps and replicates noss, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20,fig.height=8}
data = readRDS('~/Dokumente/default.reads.replicates.timepoints.3.rds') 
tab = GetAnalysisTable(data,columns=c('Half-life'),analyses='nlls.noss')
tab = tab[,-grep('upper|lower',names(tab))]
tab$`nlls.noss.Half-life` = NULL
tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars = names(tab)[grep('Half-life',names(tab))])
  tabm$Y = (log(2)/tabm$true_d)
  tabm$diff_relative = log2(tabm$Y/tabm$value)
  names(tabm)[names(tabm) == 'variable'] <- 'method'
  tabm$reps = parse_number(sapply(c(1:length(tabm$method)), function(i)    strsplit(as.character(tabm$method[i]),'[.]')[[1]][1]))
  tabm$tps = sapply(c(1:length(tabm$method)), function(i) strsplit(as.character(tabm$method[i]),'[.]')[[1]][2])
  reps1=as.character(list(c(0,1,2,4,8),c(0,1,2,4),c(0,2,4,8),c(0,1,2,8),c(0,1,4,8)))
  reps2=as.character(list(c(0,1,2,4,8),c(0,1,2),c(0,2,4),c(0,2,8),c(0,4,8),c(0,1,4),c(0,1,8),c(0,1),c(0,2),c(0,4)))
  reps3=as.character(list(c(0,1,2,4),c(0,2,4,8),c(0,1,2,8),c(0,1,4,8)))
  reps4=as.character(list(c(0,1,2),c(0,2,4),c(0,2,8),c(0,4,8),c(0,1,4),c(0,1,8),c(0,1),c(0,2),c(0,4)))
  names(reps1) = paste0('tp',c(1:length(reps1)))
  names(reps2)=paste0('t',c(1:length(reps2)))
  names(reps3)=paste0('t',c(1:length(reps3)))
  names(reps4)=paste0('t',c(1:length(reps4)))
  for (i in c(1:length(reps2))) tabm$tps[(tabm$reps==2)&tabm$tps==paste0('t',i)] = reps2[i]
  for (i in c(1:length(reps1))) tabm$tps[(tabm$reps==1)&tabm$tps==paste0('t',i)] = reps1[i]
  for (i in c(1:length(reps3))) tabm$tps[(tabm$reps==3)&tabm$tps==paste0('t',i)] = reps3[i]
  for (i in c(1:length(reps4))) tabm$tps[(tabm$reps==4)&tabm$tps==paste0('t',i)] = reps4[i]
  tabm$ltp = sapply(c(1:length(tabm$tps)), function(i) length((strsplit(tabm$tps[[i]],'[,]')[[1]])))
tabm$HL <- sapply(tabm$Y, FUN = function(x) if(x<1) '0h-1h' else if ((x>=1)&(x<2)) '1h-2h'else if ((x>=2)&(x<4)) '2h-4h' else '4h and more')
tabm$tps = tabm$tps %>% stringr::str_match_all("[0-9]+") %>% sapply(function(i) paste0(i,'h')) %>% sapply(toString)
tabm$labels = paste(tabm$reps, 'x', tabm$tps)
ggplot(tabm, aes(x=reorder(labels,ltp),y=diff_relative,fill=HL)) + theme_minimal_hgrid()+
  geom_boxplot(notch=T)+
 coord_cartesian(ylim = c(-0.5,2.15))+scale_y_continuous(breaks = seq(from = -0.5, to =2.15, by = 0.3))+
  theme(axis.text.x = element_text(size=12, angle=90, hjust = 1, vjust = 0.4)) + ylab('log FC true HL/inferred HL') + xlab('') + scale_fill_brewer(palette='Reds')
```


```{r}
data = readRDS('~/Dokumente/default.replicates.timepoints.reads.noss.rds')
tab = GetAnalysisTable(data,columns=c('Half-life'),analyses='nlls.ss')
tab = tab[,-grep('upper|lower',names(tab))]
tab$`nlls.ss.Half-life` = NULL
tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars = names(tab)[grep('Half-life',names(tab))])
tabm$Y = (log(2)/tabm$true_d)
tabm$diff_relative = log2(tabm$Y/tabm$value)
reads = c('5E5','1E6','1E7','4E7','5E7','2E7')
names(tabm)[names(tabm) == 'variable'] <- 'method'
tabm$reads = sapply(c(1:length(tabm$method)), function(i) reads[as.numeric(strsplit(as.character(tabm$method[i]),'[.]')[[1]][2])])
tabm$reads = factor(as.character(tabm$reads), levels = c('5E5','1E6','1E7','2E7','4E7','5E7'))
ggplot(tabm, aes(x=diff_relative, color=reads, linetype=reads)) + 
  stat_ecdf(geom = "line", size=0.8)+ coord_cartesian(xlim=c(-2,1.5)) + xlab('log2 fold change') + ylab('cumulative frequency') + geom_vline(xintercept = 0) + scale_color_brewer(palette='Oranges')

```
```{r}
data = readRDS('~/Dokumente/default.replicates.timepoints.reads.noss.rds')
tab = GetAnalysisTable(data,columns=c('Half-life'),analyses='nlls.noss')
tab = tab[,-grep('upper|lower',names(tab))]
tab$`nlls.noss.Half-life` = NULL
tabm = melt(tab, id.vars =c('Gene','Symbol','true_d','true_s'),
            measure.vars = names(tab)[grep('Half-life',names(tab))])
tabm$Y = (log(2)/tabm$true_d)
#tabm$diff_relative = log2(tabm$Y/tabm$value)
tabm$diff_relative = log2(tabm$Y)- log2(tabm$value)
reads = c('5E5','1E6','1E7','4E7','5E7','2E7')
names(tabm)[names(tabm) == 'variable'] <- 'method'
tabm$reads = sapply(c(1:length(tabm$method)), function(i) reads[as.numeric(strsplit(as.character(tabm$method[i]),'[.]')[[1]][2])])
tabm$reads = factor(as.character(tabm$reads), levels = c('5E5','1E6','1E7','2E7','4E7','5E7'))
ggplot(tabm, aes(x=diff_relative, color=reads, linetype=reads)) + stat_ecdf(geom = "line", size=0.8)+ coord_cartesian(xlim=c(-4,3)) + xlab('log2 fold change') + ylab('cumulative frequency') +geom_vline(xintercept = 0)+ scale_color_brewer(palette='Oranges')
```

